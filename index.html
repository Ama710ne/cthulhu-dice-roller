<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>æ–°ãƒ»ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ç¥è©±TRPG ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ©ãƒ¼ v7.9.1</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";
Â  Â  Â  background: #0f172a;
Â  Â  Â  color: #e2e8f0;
Â  Â  Â  padding: 20px;
Â  Â  }
Â  Â  .success Â { color: #22c55e; text-shadow: 0 0 6px #22c55e; }
Â  Â  .failure Â { color: #ef4444; text-shadow: 0 0 6px #ef4444; }
Â  Â  .critical { color: #3b82f6; font-weight: bold; text-shadow: 0 0 10px #60a5fa; }
Â  Â  .fumble Â  { color: #f97316; font-weight: bold; text-shadow: 0 0 8px #fb923c; }
Â  Â  .special Â { color: #8b5cf6; font-weight: bold; text-shadow: 0 0 8px #a78bfa; }
Â  Â  .hard Â  Â  { color: #facc15; font-weight: bold; text-shadow: 0 0 8px #fde047; }
Â  </style>
</head>
<body>
Â  <h1 class="text-2xl font-bold mb-4">æ–°ãƒ»ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ç¥è©±TRPG ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ©ãƒ¼ v7.9.1</h1>

Â  <!-- ãƒ­ãƒ“ãƒ¼ -->
Â  <section id="lobby" class="mb-4 space-y-2">
Â  Â  <div>
Â  Â  Â  <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼š</label>
Â  Â  Â  <input id="player-name" class="rounded bg-slate-800 px-3 py-2" placeholder="PL_åå‰">
Â  Â  </div>
Â  Â  <div>
Â  Â  Â  <label>éƒ¨å±‹IDï¼š</label>
Â  Â  Â  <input id="room-id" class="rounded bg-slate-800 px-3 py-2" placeholder="ä¾‹: ABC123">
Â  Â  </div>
Â  Â  <div>
Â  Â  Â  <label>KPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆKPã®ã¿ï¼‰ï¼š</label>
Â  Â  Â  <input id="kp-password" type="password" class="rounded bg-slate-800 px-3 py-2">
Â  Â  </div>
Â  Â  <div class="space-x-2">
Â  Â  Â  <button id="create-room" class="bg-green-600 px-3 py-2 rounded">éƒ¨å±‹ã‚’ä½œæˆ</button>
Â  Â  Â  <button id="join-room" class="bg-blue-600 px-3 py-2 rounded">éƒ¨å±‹ã«å‚åŠ </button>
Â  Â  </div>
Â  Â  <div id="lobby-msg" class="text-sm text-slate-400"></div>
Â  </section>

Â  <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
Â  <section id="main" class="hidden">
Â  Â  <div class="flex justify-between mb-4 items-center">
Â  Â  Â  <div>
Â  Â  Â  Â  <strong>æ¢ç´¢è€…ï¼š</strong>
Â  Â  Â  Â  <select id="char-select" class="bg-slate-800 px-2 py-1 rounded text-sm"></select>ã€€
Â  Â  Â  Â  <strong>ãƒ¢ãƒ¼ãƒ‰ï¼š</strong> <span id="mode-indicator">PL</span>ã€€
Â  Â  Â  Â  <strong>éƒ¨å±‹IDï¼š</strong> <span id="room-display" class="text-yellow-400 font-mono">---</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="space-x-2">
Â  Â  Â  Â  <input id="new-room-id" placeholder="æ–°ã—ã„éƒ¨å±‹ID" class="bg-slate-800 px-2 py-1 rounded text-sm w-32">
Â  Â  Â  Â  <button id="change-room-id" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded text-sm">IDå¤‰æ›´</button>
Â  Â  Â  Â  <button id="delete-room" class="hidden bg-red-700 hover:bg-red-800 text-white px-3 py-1 rounded text-sm">å‰Šé™¤</button>
Â  Â  Â  Â  <button id="exit-room" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded text-sm">é€€å‡º</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="mb-3">
Â  Â  Â  <label>æ¢ç´¢è€…JSONã‚’èª­ã¿è¾¼ã‚€ï¼ˆè¤‡æ•°å¯ï¼‰ï¼š</label>
Â  Â  Â  <input id="char-file" type="file" accept=".json" multiple class="bg-slate-800 px-3 py-2 rounded">
Â  Â  </div>

Â  Â  <div id="status-section" class="mb-4">
Â  Â  Â  <h2 class="font-bold mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
Â  Â  Â  <div id="status-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-2"></div>
Â  Â  Â  <div class="text-red-400 font-semibold text-lg">HPï¼š<span id="hp-display">--</span></div>
Â  Â  Â  <div class="mt-2">
Â  Â  Â  Â  <input id="hp-input" type="number" class="w-24 bg-slate-800 px-2 py-1 rounded" placeholder="HPã‚’å¤‰æ›´">
Â  Â  Â  Â  <button id="update-hp" class="bg-blue-500 hover:bg-blue-600 px-3 py-2 rounded">å¤‰æ›´</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="skills-section" class="mb-4">
Â  Â  Â  <h2 class="font-bold mb-2">æŠ€èƒ½ãƒ»èƒ½åŠ›ä¸€è¦§</h2>
Â  Â  Â  <div id="skill-buttons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 overflow-auto max-h-[60vh]"></div>
Â  Â  </div>

Â  Â  <div class="mb-4">
Â  Â  Â  <label>ä¿®æ­£å€¤ï¼š</label>
Â  Â  Â  <input id="modifier" type="number" value="0" class="w-24 bg-slate-800 px-2 py-1 rounded">
Â  Â  Â  <label class="ml-4"><input id="private-roll" type="checkbox" class="mr-1">ç§˜åŒ¿ãƒ€ã‚¤ã‚¹</label>
Â  Â  </div>

Â  Â  <div class="mb-6">
Â  Â  Â  <button id="roll-btn" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded font-bold">è‡ªç”±ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹</button>
Â  Â  Â  <input id="expr" placeholder="ä¾‹ï¼š3d6+1d4-2" class="ml-2 bg-slate-800 px-3 py-2 rounded w-48">
Â  Â  </div>

Â  Â  <div id="inline-result" class="text-center mb-4">
Â  Â  Â  <div id="inline-value" class="text-3xl font-extrabold">--</div>
Â  Â  Â  <div id="inline-text" class="text-slate-300 text-lg">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
Â  Â  </div>

Â  Â  <div>
Â  Â  Â  <h3 class="font-bold mb-2">å±¥æ­´</h3>
Â  Â  Â  <div id="history" class="space-y-1 max-h-[60vh] overflow-y-auto text-sm"></div>
Â  Â  </div>
Â  </section>

Â  <!-- Firebase -->
Â  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
Â  <script>
Â  // Firebase åˆæœŸåŒ–
Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBrfXedwhmcCGYWrNaCJTN7xgTJUTqwwG0",
Â  Â  authDomain: "daisurora.firebaseapp.com",
Â  Â  databaseURL: "https://daisurora-default-rtdb.firebaseio.com",
Â  Â  projectId: "daisurora",
Â  Â  storageBucket: "daisurora.firebasestorage.app",
Â  Â  messagingSenderId: "998058550723",
Â  Â  appId: "1:998058550723:web:44b5fa8f1eba105f15c976"
Â  };Â 
Â  firebase.initializeApp(firebaseConfig);
Â  const db = firebase.database();

Â  const playerName = document.getElementById("player-name");
Â  const roomIdInput = document.getElementById("room-id");
Â  const kpPassword = document.getElementById("kp-password");
Â  const createBtn = document.getElementById("create-room");
Â  const joinBtn = document.getElementById("join-room");
Â  const deleteBtn = document.getElementById("delete-room");
Â  const exitBtn = document.getElementById("exit-room");
Â  const lobby = document.getElementById("lobby");
Â  const main = document.getElementById("main");
Â  const roomDisplay = document.getElementById("room-display");
Â  const lobbyMsg = document.getElementById("lobby-msg");
Â  const charFile = document.getElementById("char-file");
Â  const charSelect = document.getElementById("char-select");
Â  const statusGrid = document.getElementById("status-grid");
Â  const skillButtons = document.getElementById("skill-buttons");
Â  const inlineText = document.getElementById("inline-text");
Â  const inlineValue = document.getElementById("inline-value");
Â  const historyDiv = document.getElementById("history");
Â  const modifierInput = document.getElementById("modifier");
Â  const privateCheck = document.getElementById("private-roll");
Â  const rollBtn = document.getElementById("roll-btn");
Â  const exprInput = document.getElementById("expr");

Â  let roomId = null;
Â  let isKP = false;
Â  let playerId = null;
Â  let roomListener = null;
Â  let knownPrivate = {};
Â  let currentChars = {};
Â  let currentChar = null;
Â  let dynamicStatus = {};

Â  // ğŸ”§ ä¿®æ­£ç‰ˆã®å¤‰æ›´ç‚¹ï¼š
Â  // - pushRoll ã§ addHistory() ã‚’å‘¼ã¶ã®ã‚’å‰Šé™¤
Â  // - listenRoom ã§äºŒé‡é˜²æ­¢ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 

Â  async function sha256Hex(str){
Â  Â  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
Â  Â  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
Â  }

Â  function showStatus(msg){ lobbyMsg.textContent = msg; }

Â  createBtn.onclick = async () => {
Â  Â  const pw = kpPassword.value.trim();
Â  Â  const name = playerName.value.trim() || "KP";
Â  Â  if (!pw) return showStatus("KPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
Â  Â  const id = roomIdInput.value.trim().toUpperCase() || Math.random().toString(36).slice(2,8).toUpperCase();
Â  Â  const exists = await db.ref("rooms/"+id+"/meta").get();
Â  Â  if (exists.exists() && !exists.val().deleted) return showStatus("ãã®éƒ¨å±‹IDã¯ä½¿ç”¨ä¸­ã§ã™ã€‚");
Â  Â  const hash = await sha256Hex(pw);
Â  Â  await db.ref("rooms/"+id+"/meta").set({kpName:name,passwordHash:hash,deleted:false});
Â  Â  roomId = id; isKP = true;
Â  Â  enterRoom();
Â  };

Â  joinBtn.onclick = async () => {
Â  Â  const id = roomIdInput.value.trim().toUpperCase();
Â  Â  if (!id) return showStatus("éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
Â  Â  const snap = await db.ref("rooms/"+id+"/meta").get();
Â  Â  if (!snap.exists()) return showStatus("éƒ¨å±‹ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
Â  Â  const meta = snap.val(); if (meta.deleted) return showStatus("å‰Šé™¤æ¸ˆã¿ã®éƒ¨å±‹ã§ã™");
Â  Â  const input = kpPassword.value.trim();
Â  Â  if (input){ const hash = await sha256Hex(input); isKP = (hash === meta.passwordHash); }
Â  Â  roomId = id; enterRoom();
Â  };

Â  function enterRoom(){
Â  Â  lobby.classList.add("hidden");
Â  Â  main.classList.remove("hidden");
Â  Â  roomDisplay.textContent = roomId;
Â  Â  listenRoom();
Â  }

Â  exitBtn.onclick = ()=>exitRoom();
Â  function exitRoom(){Â 
Â  Â  if(roomListener) db.ref("rooms/"+roomId+"/rolls").off("child_added", roomListener);
Â  Â  lobby.classList.remove("hidden"); main.classList.add("hidden");
Â  }

Â  deleteBtn.onclick = async ()=>{
Â  Â  if(!isKP) return alert("KPã®ã¿å‰Šé™¤å¯èƒ½");
Â  Â  if(confirm("ã“ã®éƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
Â  Â  Â  await db.ref("rooms/"+roomId).remove();
Â  Â  Â  alert("éƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
Â  Â  Â  exitRoom();
Â  Â  }
Â  };

Â  function listenRoom(){
Â  Â  roomListener = snap=>{
Â  Â  Â  const d = snap.val();
Â  Â  Â  if(document.querySelector(`[data-timestamp="${d.timestamp}"]`)) return; // äºŒé‡é˜²æ­¢
Â  Â  Â  const sameUser = (d.player === playerName.value.trim());
Â  Â  Â  if(!d.hidden || isKP || knownPrivate[d.timestamp] || sameUser) addHistory(d);
Â  Â  };
Â  Â  db.ref("rooms/"+roomId+"/rolls").on("child_added", roomListener);
Â  }

Â  function addHistory(d){
Â  Â  const div=document.createElement("div");
Â  Â  div.dataset.timestamp=d.timestamp;
Â  Â  const time=new Date(d.timestamp).toLocaleTimeString();
Â  Â  const value=d.modified??d.total??d.raw??"";
Â  Â  div.innerHTML=`<span class="${d.cls||''}">${d.player||'åŒ¿å'}ï¼š${d.skill?d.skill+' â†’ ':''}${d.status||d.expr}ï¼ˆ${value}ï¼‰<br><small>${time}</small></span>`;
Â  Â  historyDiv.prepend(div);
Â  }

Â  function pushRoll(d){
Â  Â  if(!roomId){ addHistory(d); return; }
Â  Â  db.ref("rooms/"+roomId+"/rolls").push(d);
Â  Â  if(d.hidden) knownPrivate[d.timestamp]=true;
Â  }

Â  function rollD(n){ return Math.floor(Math.random()*n)+1; }

Â  function parseDice(expr){
Â  Â  const parts = expr.match(/([+-]?\d*d\d+|[+-]?\d+)/g);
Â  Â  if(!parts) return {total:NaN, rolls:[]};
Â  Â  let total=0; const rolls=[];
Â  Â  for(let part of parts){
Â  Â  Â  let sign=1;
Â  Â  Â  if(part.startsWith('-')){ sign=-1; part=part.slice(1); }
Â  Â  Â  if(part.startsWith('+')) part=part.slice(1);
Â  Â  Â  if(part.includes('d')){
Â  Â  Â  Â  const [a,b]=part.split('d').map(x=>parseInt(x)||0);
Â  Â  Â  Â  for(let i=0;i<(a||1);i++){ const r=rollD(b); rolls.push(r*sign); total+=r*sign; }
Â  Â  Â  } else total+=sign*(parseInt(part)||0);
Â  Â  }
Â  Â  return {total, rolls};
Â  }

Â  function calcResult(raw, skillVal){
Â  Â  const special = Math.ceil(skillVal / 5);
Â  Â  const hard = Math.ceil(skillVal / 2);
Â  Â  if(raw <= 5) return {status:"ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼", cls:"critical"};
Â  Â  if((raw>=96 && skillVal<100) || raw===100) return {status:"ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«", cls:"fumble"};
Â  Â  if(raw <= special) return {status:"ã‚¹ãƒšã‚·ãƒ£ãƒ«æˆåŠŸ", cls:"special"};
Â  Â  if(raw <= hard) return {status:"ãƒãƒ¼ãƒ‰æˆåŠŸ", cls:"hard"};
Â  Â  if(raw <= skillVal) return {status:"æˆåŠŸ", cls:"success"};
Â  Â  return {status:"å¤±æ•—", cls:"failure"};
Â  }

Â  rollBtn.onclick=()=>{
Â  Â  const expr=exprInput.value.trim()||"1d100";
Â  Â  const parsed=parseDice(expr);
Â  Â  inlineValue.textContent=parsed.total;
Â  Â  inlineText.textContent=`${expr} â†’ [${parsed.rolls.join(', ')}] = ${parsed.total}`;
Â  Â  pushRoll({player:playerName.value.trim()||"åŒ¿å",expr,rolls:parsed.rolls,total:parsed.total,hidden:!!privateCheck.checked,timestamp:Date.now()});
Â  };

Â  showStatus("æº–å‚™å®Œäº†ã€‚éƒ¨å±‹ã‚’ä½œæˆã¾ãŸã¯å‚åŠ ã—ã¦ãã ã•ã„ã€‚");
Â  </script>
</body>
</html>