<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ–°ãƒ»ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ç¥è©±TRPG ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ©ãƒ¼ v7.7.5</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";
  background: #0f172a;
  color: #e2e8f0;
  padding: 20px;
}
.success  { color: #22c55e; text-shadow: 0 0 6px #22c55e; }
.failure  { color: #ef4444; text-shadow: 0 0 6px #ef4444; }
.critical { color: #3b82f6; font-weight: bold; text-shadow: 0 0 10px #60a5fa; }
.fumble   { color: #f97316; font-weight: bold; text-shadow: 0 0 8px #fb923c; }
.special  { color: #8b5cf6; font-weight: bold; text-shadow: 0 0 8px #a78bfa; }
.hard     { color: #facc15; font-weight: bold; text-shadow: 0 0 8px #fde047; }
</style>
</head>
<body>
<h1 class="text-2xl font-bold mb-4">æ–°ãƒ»ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ç¥è©±TRPG ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ©ãƒ¼ v7.7R</h1>

<!-- ãƒ­ãƒ“ãƒ¼ -->
<section id="lobby" class="mb-4 space-y-2">
  <div>
    <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼š</label>
    <input id="player-name" class="rounded bg-slate-800 px-3 py-2" placeholder="PL_åå‰">
  </div>
  <div>
    <label>éƒ¨å±‹IDï¼š</label>
    <input id="room-id" class="rounded bg-slate-800 px-3 py-2" placeholder="ä¾‹: ABC123">
  </div>
  <div>
    <label>KPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆKPã®ã¿ï¼‰ï¼š</label>
    <input id="kp-password" type="password" class="rounded bg-slate-800 px-3 py-2">
  </div>
  <div class="space-x-2">
    <button id="create-room" class="bg-green-600 px-3 py-2 rounded">éƒ¨å±‹ã‚’ä½œæˆ</button>
    <button id="join-room" class="bg-blue-600 px-3 py-2 rounded">éƒ¨å±‹ã«å‚åŠ </button>
  </div>
  <div id="lobby-msg" class="text-sm text-slate-400 mt-1">éƒ¨å±‹ã‚’ä½œæˆã¾ãŸã¯å‚åŠ ã—ã¦ãã ã•ã„ã€‚</div>
</section>

<!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
<section id="main" class="hidden">
  <div class="flex justify-between mb-4 items-center">
    <div>
      <strong>ãƒ¢ãƒ¼ãƒ‰ï¼š</strong> <span id="mode-indicator">PL</span>ã€€
      <strong>éƒ¨å±‹IDï¼š</strong> <span id="room-display" class="text-yellow-400 font-mono">---</span>
    </div>
    <div class="space-x-2">
      <button id="delete-room" class="hidden bg-red-700 hover:bg-red-800 text-white px-3 py-1 rounded text-sm">éƒ¨å±‹å‰Šé™¤</button>
      <button id="exit-room" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded text-sm">é€€å‡º</button>
    </div>
  </div>

  <div class="mb-3">
    <label>æ¢ç´¢è€…JSONã‚’èª­ã¿è¾¼ã‚€ï¼š</label>
    <input id="char-file" type="file" accept=".json" multiple class="bg-slate-800 px-3 py-2 rounded">
  </div>

  <div id="status-section" class="mb-4">
    <h2 class="font-bold mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
    <div id="status-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-2"></div>
  </div>

  <div id="skills-section" class="mb-4">
    <h2 class="font-bold mb-2">æŠ€èƒ½ä¸€è¦§</h2>
    <div id="skill-buttons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 overflow-auto max-h-[60vh]"></div>
  </div>

  <div class="mb-4">
    <label>ä¿®æ­£å€¤ï¼š</label>
    <input id="modifier" type="number" value="0" class="w-24 bg-slate-800 px-2 py-1 rounded">
    <label class="ml-4"><input id="private-roll" type="checkbox" class="mr-1">ç§˜åŒ¿ãƒ€ã‚¤ã‚¹</label>
  </div>

  <div class="mb-6">
    <button id="roll-btn" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded font-bold">è‡ªç”±ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹</button>
    <input id="expr" placeholder="ä¾‹ï¼š3d6+1d4-2" class="ml-2 bg-slate-800 px-3 py-2 rounded w-48">
  </div>

  <div id="inline-result" class="text-center mb-4">
    <div id="inline-value" class="text-3xl font-extrabold">--</div>
    <div id="inline-text" class="text-slate-300 text-lg">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
  </div>

  <div>
    <h3 class="font-bold mb-2">å±¥æ­´</h3>
    <div id="history" class="space-y-1 max-h-[60vh] overflow-y-auto text-sm"></div>
  </div>
</section>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBrfXedwhmcCGYWrNaCJTN7xgTJUTqwwG0",
  authDomain: "daisurora.firebaseapp.com",
  databaseURL: "https://daisurora-default-rtdb.firebaseio.com",
  projectId: "daisurora",
  storageBucket: "daisurora.firebasestorage.app",
  messagingSenderId: "998058550723",
  appId: "1:998058550723:web:44b5fa8f1eba105f15c976",
  measurementId: "G-EKF2JENYMK"
}; 
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const lobby = document.getElementById("lobby");
const main = document.getElementById("main");
const lobbyMsg = document.getElementById("lobby-msg");
const createBtn = document.getElementById("create-room");
const joinBtn = document.getElementById("join-room");
const deleteBtn = document.getElementById("delete-room");
const exitBtn = document.getElementById("exit-room");
const playerName = document.getElementById("player-name");
const kpPassword = document.getElementById("kp-password");
const roomIdInput = document.getElementById("room-id");
const roomDisplay = document.getElementById("room-display");
const charFile = document.getElementById("char-file");
const charSelect = document.getElementById("char-select");
const statusGrid = document.getElementById("status-grid");
const skillButtons = document.getElementById("skill-buttons");
const modifierInput = document.getElementById("modifier");
const privateCheck = document.getElementById("private-roll");
const rollBtn = document.getElementById("roll-btn");
const exprInput = document.getElementById("expr");
const inlineText = document.getElementById("inline-text");
const inlineValue = document.getElementById("inline-value");
const historyDiv = document.getElementById("history");

let roomId=null,isKP=false,roomListener=null,deleteListener=null;
let knownPrivate={},playerId="id_"+Math.random().toString(36).slice(2,10);
let currentChar=null,dynamicStatus={};

function showStatus(msg){ lobbyMsg.textContent=msg; }

async function sha256Hex(str){
  const buf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ================== éƒ¨å±‹ä½œæˆ ==================
createBtn.onclick = async () => {
  showStatus("â³ éƒ¨å±‹ã‚’ä½œæˆã—ã¦ã„ã¾ã™â€¦");
  const pw=kpPassword.value.trim(), name=playerName.value.trim()||"KP";
  if(!pw) return showStatus("KPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  const id=roomIdInput.value.trim().toUpperCase()||Math.random().toString(36).slice(2,8).toUpperCase();
  const exists=await db.ref("rooms/"+id+"/meta").get();
  if(exists.exists() && !exists.val().deleted)
    return showStatus("âš ï¸ ãã®éƒ¨å±‹IDã¯ã™ã§ã«ä½¿ç”¨ä¸­ã§ã™ã€‚åˆ¥ã®IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
  const hash=await sha256Hex(pw);
  await db.ref("rooms/"+id+"/meta").set({kpName:name,passwordHash:hash,createdAt:Date.now(),deleted:false});
  showStatus("âœ… éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸï¼å…¥å®¤ä¸­â€¦");
  setTimeout(()=>enterRoom(id,true),600);
};

// ================== éƒ¨å±‹å‚åŠ  ==================
joinBtn.onclick = async ()=>{
  showStatus("ğŸ”„ éƒ¨å±‹ã«å‚åŠ ã—ã¦ã„ã¾ã™â€¦");
  const id=roomIdInput.value.trim().toUpperCase();
  if(!id) return showStatus("éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  const snap=await db.ref("rooms/"+id+"/meta").get();
  if(!snap.exists()) return showStatus("éƒ¨å±‹ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
  const meta=snap.val();
  if(meta.deleted) return showStatus("ã“ã®éƒ¨å±‹ã¯å‰Šé™¤æ¸ˆã¿ã§ã™");
  const input=kpPassword.value.trim();
  if(input){
    const hash=await sha256Hex(input);
    isKP=(hash===meta.passwordHash);
  }
  showStatus("âœ… å…¥å®¤ã—ã¾ã—ãŸï¼");
  setTimeout(()=>enterRoom(id,false),600);
};

function enterRoom(id,kp){
  roomId=id;isKP=kp;
  lobby.classList.add("hidden");
  main.classList.remove("hidden");
  roomDisplay.textContent=roomId;
  if(isKP) deleteBtn.classList.remove("hidden");
  listenRoom();
  watchDeletion();
}

// ================== éƒ¨å±‹å‰Šé™¤ ==================
deleteBtn.onclick = async ()=>{
  if(!isKP) return;
  if(!confirm("ã“ã®éƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await db.ref("rooms/"+roomId+"/meta/deleted").set(true);
  await db.ref("rooms/"+roomId).remove();
  alert("éƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  location.reload();
};

// ================== å‰Šé™¤æ¤œçŸ¥ ==================
function watchDeletion(){
  deleteListener=snap=>{
    if(snap.exists()&&snap.val()===true){
      alert("KPãŒéƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
      location.reload();
    }
  };
  db.ref("rooms/"+roomId+"/meta/deleted").on("value",deleteListener);
}

// ================== JSONèª­ã¿è¾¼ã¿ ==================
charFile.onchange = e=>{
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const ch=JSON.parse(ev.target.result);
      loadCharacter(ch);
    }catch{alert("JSONã‚¨ãƒ©ãƒ¼");}
  };
  reader.readAsText(file);
};

// ================== æ¢ç´¢è€…åæ˜  ==================
function loadCharacter(ch){
  const attributes=ch.ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹||{};
  const skills=ch.æŠ€èƒ½||{};
  statusGrid.innerHTML="";skillButtons.innerHTML="";
  for(const [k,v] of Object.entries(attributes)){
    const wrap=document.createElement("div");
    wrap.className="flex items-center space-x-2";
    const label=document.createElement("span");
    label.textContent=`${k}ï¼š`;
    const input=document.createElement("input");
    input.type="number";input.value=v;
    input.className="w-20 bg-slate-800 rounded px-2 py-1 text-sm";
    input.oninput=()=>dynamicStatus[k]=parseInt(input.value)||0;
    const btn=document.createElement("button");
    btn.textContent="æŒ¯ã‚‹";
    btn.className="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-sm";
    btn.onclick=()=>rollSkill(k,parseInt(input.value)||0);
    wrap.append(label,input,btn);
    statusGrid.appendChild(wrap);
  }
  for(const [name,val] of Object.entries(skills)){
    const btn=document.createElement("button");
    btn.textContent=`${name} (${val})`;
    btn.className="bg-slate-700 hover:bg-slate-600 rounded px-2 py-1 text-sm";
    btn.onclick=()=>rollSkill(name,parseInt(val)||0);
    skillButtons.appendChild(btn);
  }
}

// ================== åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ==================
function rollD(n){return Math.floor(Math.random()*n)+1;}
function calcResult(raw,skill){
  const sp=Math.ceil(skill/5), hd=Math.ceil(skill/2);
  if(raw<=5)return{t:"ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼",c:"critical"};
  if((raw>=96&&skill<100)||raw===100)return{t:"ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«",c:"fumble"};
  if(raw===sp)return{t:"ã‚¹ãƒšã‚·ãƒ£ãƒ«æˆåŠŸ",c:"special"};
  if(raw===hd)return{t:"ãƒãƒ¼ãƒ‰æˆåŠŸ",c:"hard"};
  if(raw<=skill)return{t:"æˆåŠŸ",c:"success"};
  return{t:"å¤±æ•—",c:"failure"};
}
function rollSkill(name,val){
  const raw=rollD(100);
  const res=calcResult(raw,val);
  inlineValue.textContent=raw;
  inlineText.textContent=`${name}(${val}) â†’ ${res.t}`;
  inlineText.className=res.c;
  pushRoll({player:playerName.value||"åŒ¿å",skill:name,val,raw,status:res.t,cls:res.c,hidden:privateCheck.checked,timestamp:Date.now()});
}

// ================== å±¥æ­´é€ä¿¡/å—ä¿¡ ==================
function pushRoll(d){
  db.ref("rooms/"+roomId+"/rolls").push(d);
  addHistory(d);
}
function listenRoom(){
  db.ref("rooms/"+roomId+"/rolls").on("child_added",snap=>{
    const d=snap.val();
    if(!d)return;
    if(!d.hidden||isKP||d.player===playerName.value)addHistory(d);
  });
}
function addHistory(d){
  const div=document.createElement("div");
  const time=new Date(d.timestamp).toLocaleTimeString();
  div.innerHTML=`<span class="${d.cls||''}">${d.player}ï¼š${d.skill?d.skill+' â†’ ':''}${d.status||''} (${d.raw||''})<br><small>${time}</small></span>`;
  historyDiv.prepend(div);
}

showStatus("æº–å‚™å®Œäº†ã€‚éƒ¨å±‹ã‚’ä½œæˆã¾ãŸã¯å‚åŠ ã—ã¦ãã ã•ã„ã€‚");
</script>
</body>
</html>
